<script>
  let form = document.querySelector("form");
  let TAB,COLUMN;
  let selector, ddlFrom;
  form.addEventListener("submit", handleFormSubmit);
  const sheetName = document.title;
  console.log("TO_SEARCH:", toSearch);

  main();
  async function main() {
    [TAB, COLUMN] = await Promise.all(getConstants());

    switch (sheetName) {
      
      case TAB.CONTRACTS:
        ddlFrom = {
          kam:              { 
            selector: "datalist#kam", 
            sheet: TAB.DATA, 
            column: COLUMN.DATA.KAM 
          },
          transactionType:  { 
            selector: "datalist#transaction-type", 
            sheet: TAB.DATA, 
            column: COLUMN.DATA.TRANSACTION_TYPE 
          },
          landlord:         { 
            selector: "datalist#landlord", 
            sheet: TAB.CONTACTS, 
            column: COLUMN.CONTACTS.FULL_NAME 
          },
          contractStatus:   { 
            selector: "datalist#contract-status", 
            sheet: TAB.DATA, 
            column: COLUMN.DATA.CONTRACT_STATUS 
          },
          property:         { 
            selector: "datalist#property", 
            sheet: TAB.PROPERTIES, 
            column: COLUMN.PROPERTIES.NAME_AUTOFILL 
          },
          client:           { 
            selector: "datalist#client", 
            sheet: TAB.CONTACTS, 
            column: COLUMN.CONTACTS.FULL_NAME 
          },
          propertyContact:  { 
            selector: "datalist#property-contact", 
            sheet: TAB.CONTACTS, 
            column: COLUMN.CONTACTS.FULL_NAME 
          },
          remainingPayment:  { 
            selector: "datalist#remaining-payment", 
            sheet: TAB.DATA, 
            column: COLUMN.DATA.REMAINING_PAYMENT 
          },
          associationDues:  { 
            selector: "datalist#association-dues", 
            sheet: TAB.DATA, 
            column: COLUMN.DATA.ASSOCIATION_DUES 
          },
        };
        selector = {
          kam:                "input[name=kam]",
          transactionType:    "input[name=transaction-type]",
          contractStartDate:  "input[name=contract-start-date]",
          contractEndDate:    "input[name=contract-end-date]",
          contractDuration:   "input[name=contract-duration]",
          landlord:           "input[name=landlord]",
          grossSalesRate:     "input[name=gross-sales-rate]",
          contractStatus:     "input[name=contract-status]",
          property:           "input[name=property]",
          client:             "input[name=client]",
          propertyContact:    "input[name=property-contact]",
          contractUrl:        "input[name=contract-url]",
          petClause:          "input[name=pet-clause]",
          inventoryList:      "input[name=inventory-list]",
          parkingSlotNo:      "input[name=parking-slot-no]",
          advanceApplicableOn:"input[name=advance-applicable-on]",
          deposit:            "input[name=deposit]",
          remainingPayment:   "input[name=remaining-payment]",
          associationDues:    "input[name=association-dues]",
        };
        break;
      
      case TAB.PAYMENTS:
        ddlFrom = {
          reference:          { selector: "datalist#reference", sheet: TAB.CONTRACTS, column: COLUMN.CONTRACTS.REFERENCE },
          externalAgentName:  { selector: "datalist#external-agent-name", sheet: TAB.CONTACTS, column: COLUMN.CONTACTS.FULL_NAME },
          internalAgentName:  { selector: "datalist#internal-agent-name", sheet: TAB.CONTACTS, column: COLUMN.CONTACTS.FULL_NAME },
          costType:           { selector: "datalist#cost-type", sheet: TAB.DATA, column: COLUMN.DATA.COST_TYPE },
        };
        selector = {
          reference:                "input[name=reference]",
          dues:                     "input[name=dues]",
          netSalesRate:             "input[name=net-sales-rate]",
          comRate:                  "input[name=com-rate]",
          grossCom:                 "input[name=gross-com]",
          discountPercent:          "input[name=discount-percent]",
          discountPhp:              "input[name=discount-php]",
          netCom:                   "input[name=net-com]",
          externalAgentGciPhp:      "input[name=external-agent-gci-php]",
          externalAgentGciPercent:  "input[name=external-agent-gci-percent]",
          externalAgentName:        "input[name=external-agent-name]",
          propelGciPercent:         "input[name=propel-gci-percent]",
          propelGciPhp:             "input[name=propel-gci-php]",
          internalAgentPhp:         "input[name=internal-agent-php]",
          internalAgentName:        "input[name=internal-agent-name]",
          internalAgentPercent:     "input[name=internal-agent-percent]",
          costType:                 "input[name=cost-type]",
          paymentDueDate:           "input[name=payment-due-date]",
          paymentRecord1:           "input[name=payment-record-1]",
        };
        break;
      
      case TAB.PROPERTIES:
        ddlFrom = {
          type:               { selector: "datalist#type", sheet: TAB.DATA, column: COLUMN.DATA.TRANSACTION_TYPE },
          kam:                { selector: "datalist#kam", sheet: TAB.DATA, column: COLUMN.DATA.KAM },
          propertyConnection: { selector: "datalist#property-connection", sheet: TAB.DATA, column: COLUMN.DATA.PROPERTY_CONNECTION },
          buildingVillage:    { selector: "datalist#building-village", sheet: TAB.DATA, column: COLUMN.DATA.BUILDING },
          furnished:          { selector: "datalist#furnished", sheet: TAB.DATA, column: COLUMN.DATA.FURNISHING },
          propertyContact:    { selector: "datalist#property-contact", sheet: TAB.CONTACTS, column: COLUMN.CONTACTS.FULL_NAME },
          landlord:           { selector: "datalist#landlord", sheet: TAB.CONTACTS, column: COLUMN.CONTACTS.FULL_NAME },
          propertyType:       { selector: "datalist#property-type", sheet: TAB.DATA, column: COLUMN.DATA.PROPERTY_TYPE },
        };
        selector = {
          type:               "input[name=type]",
          kam:                "input[name=kam]",
          propertyConnection: "input[name=property-connection]",
          buildingVillage:    "input[name=building-village]",
          towerStreet:        "input[name=tower-street]",
          unit:               "input[name=unit]",
          unitType:           "input[name=unit-type]",
          sqm:                "input[name=sqm]",
          furnished:          "input[name=furnished]",
          rentMonth:          "input[name=rent-month]",
          salesPrice:         "input[name=sales-price]",
          petfriendly:        "input[name=petfriendly]",
          balcony:            "input[name=balcony]",
          parking:            "input[name=parking]",
          maidsroom:          "input[name=maidsroom]",
          facingView:         "input[name=facing-view]",
          comment:            "input[name=comment]",
          urlToPictures:      "input[name=url-to-pictures]",
          propertyContact:    "input[name=property-contact]",
          landlord:           "input[name=landlord]",
          propertyType:       "input[name=property-type]",
          propertyStreet:     "input[name=property-street]",
          propertyAddress:    "input[name=property-address]",
        };
        break;

      case TAB.CONTACTS:
        ddlFrom = {
          kam:              { selector: "datalist#kam", sheet: TAB.DATA, column: COLUMN.DATA.KAM},
          contactType:      { selector: "datalist#contact-type", sheet: TAB.DATA, column: COLUMN.DATA.CONTACT_TYPE},
        };
        selector = {
          fullName:           "input[name=full-name]",
          kam:                "input[name=kam]",
          contactType:        "input[name=contact-type]",
          nationality:        "input[name=nationality]",
          employer:           "input[name=employer]",
          address:            "input[name=address]",
          mobile:             "input[name=mobile]",
          email:              "input[name=email]",
          idLink:             "input[name=id-link]",
        };
        break;

    }
    for (let key in ddlFrom) {
      console.log("Dialog key:", key);
      let { selector } = ddlFrom[key];
      let element = document.querySelector(selector);
      google.script.run
        .withSuccessHandler((r) => fillDDL(element, r))
        .getColumnContent(ddlFrom[key].sheet, ddlFrom[key].column);
    }
    let rowIndex = await searchContent();
    let content = await getContent(rowIndex);
    fillDialog(content);
  }

  function searchContent() {
    return new Promise ((resolve, reject) => {
      google.script.run
        .withSuccessHandler((rowIndex) => resolve(rowIndex))
        .searchRow(sheetName, toSearch);
    })
  }

  function getContent(index) {
    return new Promise ((resolve, reject) => {
      google.script.run
        .withSuccessHandler((rowObject) => resolve(rowObject))
        .getRowObject(sheetName, index);
    })
  }

  function updateRowContent(index, content) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler((r) => resolve(r))
        .updateRowContent(sheetName, index, content);
    })
  }

  function fillDialog(content) {
    let headers = document.querySelectorAll("h1");
    for (let i = 0; i < headers.length; i++) {
      let h1 = headers[i];
      let input = h1.nextElementSibling;
      input.value = content[h1.innerHTML];
    }
  }

  function fillDDL(ddl, content) {
    // Insert one empty element
    let option = document.createElement("option");
    option.setAttribute("value", "");
    ddl.appendChild(option);
    // All other elements from google table
    for (let value of content) {
      if (!value) continue;
      let option = document.createElement("option");
      option.setAttribute("value", value);
      option.innerHTML = value;
      ddl.appendChild(option);
    }
  }

  function getConstants() {
    return ([
      new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((r) => resolve(r))
          .getTabNames();
      }),
      new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((r) => resolve(r))
          .getColumnNames();
      })
    ])
  }

  async function handleFormSubmit(e) {
    e.preventDefault();
    let rowIndex = await searchContent();
    let content = {};
    let headers = document.querySelectorAll("h1");
    for (let i = 0; i < headers.length; i++) {
      let h1 = headers[i];
      let input = h1.nextElementSibling;
      let key = h1.innerHTML;
      let value = input.value;
      content[key] = value;
    }
    await updateRowContent(rowIndex, content);
    google.script.host.close();
  }

</script>